<!DOCTYPE html>
<html>
<head>
    <title>Scan for ANT+ Devices</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <button id="scan-btn">Scan for ANT+ devices</button>
    <div id="devices"></div>

    <script>
        $(document).ready(function() {
            var socket = io.connect('http://' + document.domain + ':' + location.port);
            console.log('Attempting to connect to WebSocket');

            socket.on('connect', function() {
                console.log('WebSocket connected successfully.');
            });

            socket.on('connect_error', function(err) {
                console.log('Connection Error:', err);
            });

            $('#scan-btn').click(function() {
                console.log('Scan button clicked. Emitting start_scan event.');
                $('#devices').empty(); // Clear existing devices
                socket.emit('start_scan', {data: 'User requested to start scanning'});
            });

            socket.on('new_device', function(msg) {
                console.log('Received device: ' + msg.device_id);
                addDeviceButton(msg.device_id);
            });

            function addDeviceButton(deviceId) {
            // Fetch a random word
                $.ajax({
                    url: 'https://random-word-api.herokuapp.com/word?number=1',
                    type: 'GET',
                    success: function(data) {
                        // Assuming the API returns an array of words
                        var word = data[0]; // Get the animal name

                        // Create the label with the animal name
                        var label = $('<span/>', {
                            text: word + ': ',
                            css: {
                                marginRight: '10px'
                            }
                        });

                        // Create the device button
                        var btn = $('<button/>', {
                            text: 'Device ' + deviceId,
                            click: function () {
                                // Your existing logic to handle device button click
                                // First, stop polling
                                socket.emit('stop_polling', {data: 'Stop polling requested by user'});
                                // Then, request to start advertising the selected device as BLE
                                socket.emit('advertise_device', {device_id: deviceId});

                                alert('Advertise device ' + deviceId);
                            }
                        });

                        // Create a container div for the label and button
                        var div = $('<div/>').append(label).append(btn);

                        // Append the container div to the #devices div
                        $('#devices').append(div);
                    },
                    error: function(xhr, status, error) {
                        console.error("Error fetching random animal name:", error);
                    }
                });
            }

            function advertiseDevice(deviceId) {
                // Add your logic to advertise the device as BLE
                alert('Advertise device ' + deviceId);
            }
        });
    </script>
</body>
</html>
